{% extends "tienda/base.html" %}

{% block title %}Tienda de Plantas - Inicio{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card border-0" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
            <div class="card-body p-5">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h2 class="display-6 text-success">
                            <i class="fas fa-seedling"></i> Descubre la Naturaleza en Casa
                        </h2>
                        <p class="lead">
                            Encuentra las plantas perfectas para tu hogar, oficina o jardín. 
                            Todas nuestras plantas son cuidadas con amor y están listas para alegrar tu espacio.
                        </p>
                        <a href="{{ url_for('tienda.buscar_plantas') }}" class="btn btn-success btn-lg">
                            <i class="fas fa-search"></i> Explorar Catálogo
                        </a>
                    </div>
                    <div class="col-md-6 text-center">
                        <i class="fas fa-leaf display-1 text-success opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Carrusel de Misión, Visión, Valores, Objetivos y Metas -->
<div class="row mb-5">
    <div class="col-12">
        <div id="misionVisionCarousel" class="carousel slide" data-bs-ride="carousel">
            <!-- Indicadores -->
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#misionVisionCarousel" data-bs-slide-to="0" class="active"></button>
                <button type="button" data-bs-target="#misionVisionCarousel" data-bs-slide-to="1"></button>
                <button type="button" data-bs-target="#misionVisionCarousel" data-bs-slide-to="2"></button>
                <button type="button" data-bs-target="#misionVisionCarousel" data-bs-slide-to="3"></button>
                <button type="button" data-bs-target="#misionVisionCarousel" data-bs-slide-to="4"></button>
            </div>
            
            <!-- Slides -->
            <div class="carousel-inner rounded">
                <!-- Misión -->
                <div class="carousel-item active">
                    <div class="carousel-item-content bg-success text-white p-5">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <i class="fas fa-bullseye fa-4x mb-3"></i>
                            </div>
                            <div class="col-md-10">
                                <h3 class="display-6 mb-3">Nuestra Misión</h3>
                                <p class="lead">
                                    Conectar a las personas con la naturaleza a través de plantas de calidad, 
                                    promoviendo un estilo de vida más verde y saludable en cada hogar y espacio 
                                    de trabajo. Buscamos ser el puente entre la belleza natural y tu vida diaria.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Visión -->
                <div class="carousel-item">
                    <div class="carousel-item-content bg-info text-white p-5">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <i class="fas fa-eye fa-4x mb-3"></i>
                            </div>
                            <div class="col-md-10">
                                <h3 class="display-6 mb-3">Nuestra Visión</h3>
                                <p class="lead">
                                    Ser la tienda de plantas líder en la región, reconocida por nuestra calidad, 
                                    variedad y compromiso con la sostenibilidad. Aspiramos a crear una comunidad 
                                    de amantes de las plantas que transforme espacios y mejore la calidad de vida.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Valores -->
                <div class="carousel-item">
                    <div class="carousel-item-content bg-warning text-dark p-5">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <i class="fas fa-heart fa-4x mb-3"></i>
                            </div>
                            <div class="col-md-10">
                                <h3 class="display-6 mb-3">Nuestros Valores</h3>
                                <ul class="lead mb-0">
                                    <li><strong>Sostenibilidad:</strong> Promovemos prácticas ecológicas y responsables</li>
                                    <li><strong>Calidad:</strong> Ofrecemos solo plantas saludables y bien cuidadas</li>
                                    <li><strong>Pasión:</strong> Amamos lo que hacemos y compartimos ese amor</li>
                                    <li><strong>Integridad:</strong> Transparencia y honestidad en cada proceso</li>
                                    <li><strong>Innovación:</strong> Siempre buscamos mejorar y crecer</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Objetivos -->
                <div class="carousel-item">
                    <div class="carousel-item-content bg-primary text-white p-5">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <i class="fas fa-flag fa-4x mb-3"></i>
                            </div>
                            <div class="col-md-10">
                                <h3 class="display-6 mb-3">Nuestros Objetivos</h3>
                                <ol class="lead mb-0">
                                    <li>Expandir nuestra variedad de plantas a más de 500 especies</li>
                                    <li>Establecer programas de educación sobre cuidado de plantas</li>
                                    <li>Implementar prácticas 100% sostenibles en nuestros procesos</li>
                                    <li>Crear una comunidad activa de más de 10,000 amantes de plantas</li>
                                    <li>Reducir nuestra huella de carbono en un 30% para 2025</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Metas -->
                <div class="carousel-item">
                    <div class="carousel-item-content bg-dark text-white p-5">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <i class="fas fa-chart-line fa-4x mb-3"></i>
                            </div>
                            <div class="col-md-10">
                                <h3 class="display-6 mb-3">Nuestras Metas</h3>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card bg-transparent border-light mb-3">
                                            <div class="card-body">
                                                <h5 class="card-title">Corto Plazo</h5>
                                                <ul class="mb-0">
                                                    <li>Ampliar catálogo en un 25%</li>
                                                    <li>Lanzar blog educativo</li>
                                                    <li>Implementar programa de fidelización</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-transparent border-light mb-3">
                                            <div class="card-body">
                                                <h5 class="card-title">Largo Plazo</h5>
                                                <ul class="mb-0">
                                                    <li>Abrir 3 nuevas sucursales</li>
                                                    <li>Crear vivero propio</li>
                                                    <li>Exportar a países vecinos</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controles -->
            <button class="carousel-control-prev" type="button" data-bs-target="#misionVisionCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Anterior</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#misionVisionCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Siguiente</span>
            </button>
        </div>
    </div>
</div>

<!-- Filtros de categorías -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">
            <i class="fas fa-filter text-success"></i> Categorías
        </h4>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('tienda.tienda_index') }}" 
               class="btn btn-outline-success {% if not request.args.get('categoria') %}active{% endif %}">
                Todas
            </a>
            {% for categoria in categorias %}
            <a href="{{ url_for('tienda.plantas_por_categoria', categoria=categoria) }}" 
               class="btn btn-outline-success">
                {{ categoria|title }}
            </a>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Lista de plantas -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h4>
                <i class="fas fa-store text-success"></i> Plantas Disponibles
                <span class="badge bg-success">{{ plantas|length }}</span>
            </h4>
            <div class="dropdown">
                <button class="btn btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-sort"></i> Ordenar
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="?orden=nombre">Por nombre</a></li>
                    <li><a class="dropdown-item" href="?orden=precio_asc">Precio: menor a mayor</a></li>
                    <li><a class="dropdown-item" href="?orden=precio_desc">Precio: mayor a menor</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    {% if plantas %}
        {% for planta in plantas %}
        <div class="col-md-4 col-lg-3 mb-4">
            <div class="card card-planta {% if planta.stock < 5 %}planta-destacada{% endif %}">
                <!-- Imagen de la planta -->
                {% if planta.imagen_url %}
                <img src="{{ planta.imagen_url }}" class="card-planta-img" alt="{{ planta.nombre }}">
                {% else %}
                <div class="card-planta-img bg-light d-flex align-items-center justify-content-center">
                    <i class="fas fa-leaf fa-5x text-success opacity-25"></i>
                </div>
                {% endif %}
                
                <div class="card-planta-body">
                    <!-- Categoría -->
                    {% if planta.categoria %}
                    <div class="mb-2">
                        <span class="badge-categoria">{{ planta.categoria|title }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Nombre y especie -->
                    <h5 class="card-title">{{ planta.nombre }}</h5>
                    {% if planta.especie %}
                    <p class="text-muted small mb-2">
                        <i class="fas fa-seedling"></i> {{ planta.especie }}
                    </p>
                    {% endif %}
                    
                    <!-- Precio -->
                    <div class="mb-2">
                        <span class="precio">${{ "%.2f"|format(planta.precio) }}</span>
                    </div>
                    
                    <!-- Descripción breve -->
                    {% if planta.descripcion %}
                    <p class="card-text small text-muted mb-3">
                        {{ planta.descripcion[:100] }}{% if planta.descripcion|length > 100 %}...{% endif %}
                    </p>
                    {% endif %}
                    
                    <!-- Stock -->
                    <div class="mb-3">
                        {% if planta.stock > 10 %}
                        <span class="badge bg-success">Disponible</span>
                        {% elif planta.stock > 0 %}
                        <span class="badge bg-warning">Últimas unidades</span>
                        {% else %}
                        <span class="badge bg-danger">Agotado</span>
                        {% endif %}
                        <small class="text-muted ms-2">{{ planta.stock }} en stock</small>
                    </div>
                    
                    <!-- Botones de acción -->
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('tienda.ver_planta_tienda', id=planta.id) }}" 
                           class="btn btn-tienda btn-sm">
                            <i class="fas fa-eye"></i> Ver detalles
                        </a>
                        {% if planta.stock > 0 %}
                        <button class="btn btn-outline-success btn-sm agregar-carrito" 
                                data-planta-id="{{ planta.id }}"
                                data-planta-nombre="{{ planta.nombre }}"
                                data-planta-stock="{{ planta.stock }}">
                            <i class="fas fa-cart-plus"></i> Añadir al carrito
                        </button>
                        {% else %}
                        <button class="btn btn-outline-secondary btn-sm" disabled>
                            <i class="fas fa-times"></i> Agotado
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="alert alert-info text-center py-5">
            <i class="fas fa-seedling fa-4x text-muted mb-3"></i>
            <h4>No hay plantas disponibles en este momento</h4>
            <p>Pronto tendremos nuevas plantas en stock.</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Carrito flotante -->
<div class="carrito-flotante">
    <a href="{{ url_for('tienda.ver_carrito') }}" class="btn btn-success btn-lg rounded-circle">
        <i class="fas fa-shopping-cart"></i>
        <span id="carrito-contador" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
            0
        </span>
    </a>
</div>

{% block extra_js %}
<script>
$(document).ready(function() {
    // Función para obtener el token CSRF desde los meta tags
    function getCSRFToken() {
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        return csrfToken ? csrfToken.content : '';
    }
    
    // Función para actualizar el contador del carrito
    function actualizarContadorCarrito() {
        fetch('{{ url_for("tienda.cantidad_carrito") }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const contador = document.getElementById('carrito-contador');
                    contador.textContent = data.total_items;
                    
                    if (data.total_items > 0) {
                        contador.style.display = 'block';
                    } else {
                        contador.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error al cargar contador del carrito:', error);
            });
    }
    
    // Cargar el contador inicial del carrito
    actualizarContadorCarrito();
    
    // Agregar al carrito
    $('.agregar-carrito').click(function() {
        const plantaId = $(this).data('planta-id');
        const plantaNombre = $(this).data('planta-nombre');
        const plantaStock = $(this).data('planta-stock');
        const boton = $(this);
        const card = $(this).closest('.card');
        
        // Guardar el HTML original del botón
        const originalHtml = boton.html();
        
        // Deshabilitar botón temporalmente
        boton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Procesando...');
        
        // Hacer la petición AJAX al backend
        fetch('{{ url_for("tienda.agregar_al_carrito", planta_id=0) }}'.replace('0', plantaId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                cantidad: 1
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mostrar notificación
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Agregado al carrito!',
                        text: plantaNombre + ' ha sido agregada a tu carrito',
                        timer: 2000,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end'
                    });
                } else {
                    // Fallback si SweetAlert no está disponible
                    alert(plantaNombre + ' agregada al carrito');
                }
                
                // Actualizar contador del carrito
                const contador = document.getElementById('carrito-contador');
                contador.textContent = data.carrito_count;
                contador.style.display = 'block';
                
                // Actualizar visualización del stock
                const stockBadge = card.find('.badge');
                const stockText = card.find('small.text-muted');
                
                // Leer stock actual y reducir en 1
                let currentStock = parseInt(plantaStock) - 1;
                $(this).data('planta-stock', currentStock);
                
                // Actualizar visualización
                stockText.text(currentStock + ' en stock');
                
                if (currentStock === 0) {
                    stockBadge.removeClass('bg-success bg-warning').addClass('bg-danger').text('Agotado');
                    boton.prop('disabled', true).removeClass('btn-outline-success').addClass('btn-outline-secondary')
                        .html('<i class="fas fa-times"></i> Agotado');
                } else if (currentStock < 5) {
                    stockBadge.removeClass('bg-success').addClass('bg-warning').text('Últimas unidades');
                }
                
                // Mostrar animación de éxito
                boton.removeClass('btn-outline-success').addClass('btn-success').html('<i class="fas fa-check"></i> Agregado');
                
            } else {
                // Mostrar error
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'No se pudo agregar al carrito'
                    });
                } else {
                    alert('Error: ' + data.message);
                }
                
                // Restaurar botón
                boton.html(originalHtml).prop('disabled', false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Hubo un problema al agregar al carrito. Intenta nuevamente.'
                });
            } else {
                alert('Error al agregar al carrito');
            }
            
            // Restaurar botón en caso de error
            boton.html(originalHtml).prop('disabled', false);
        })
        .finally(() => {
            // Rehabilitar botón después de 2 segundos si aún no se ha restaurado
            setTimeout(() => {
                if (boton.prop('disabled')) {
                    boton.prop('disabled', false);
                    // Solo restaurar el HTML si no se hizo el éxito
                    if (!boton.hasClass('btn-success')) {
                        boton.html(originalHtml);
                    }
                }
            }, 2000);
            
            // Restaurar apariencia original después de 3 segundos
            setTimeout(() => {
                boton.removeClass('btn-success').addClass('btn-outline-success').html('<i class="fas fa-cart-plus"></i> Añadir al carrito');
            }, 3000);
        });
    });
    
    // Si SweetAlert no está cargado, cargarlo dinámicamente
    if (typeof Swal === 'undefined') {
        const swalScript = document.createElement('script');
        swalScript.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
        swalScript.onload = function() {
            console.log('SweetAlert cargado dinámicamente');
        };
        document.head.appendChild(swalScript);
    }
    
    // Cargar Bootstrap si no está cargado (para el carrusel)
    if (typeof bootstrap === 'undefined') {
        const bsScript = document.createElement('script');
        bsScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js';
        document.head.appendChild(bsScript);
    }
});

// Función para formatear números con separadores de miles
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
</script>

<style>
/* Estilos adicionales para el carrusel */
.carousel-item-content {
    min-height: 300px;
    display: flex;
    align-items: center;
    border-radius: 10px;
}

.carousel-indicators button {
    background-color: #198754;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin: 0 5px;
}

.carousel-control-prev-icon,
.carousel-control-next-icon {
    background-color: rgba(25, 135, 84, 0.8);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    background-size: 60% 60%;
}

.carousel-item ul, .carousel-item ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}

.carousel-item li {
    margin-bottom: 0.5rem;
}

/* Estilos para el carrito flotante */
.carrito-flotante {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1050;
}

.carrito-flotante .btn {
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3);
    transition: all 0.3s ease;
}

.carrito-flotante .btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(25, 135, 84, 0.4);
}

.carrito-flotante .badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
    min-width: 24px;
}

/* Estilos para las tarjetas de plantas */
.card-planta {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e0e0e0;
    overflow: hidden;
}

.card-planta:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.card-planta-img {
    height: 200px;
    width: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.card-planta:hover .card-planta-img {
    transform: scale(1.05);
}

.card-planta-body {
    padding: 1.25rem;
}

.badge-categoria {
    background-color: #e8f5e9;
    color: #198754;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.precio {
    font-size: 1.25rem;
    font-weight: bold;
    color: #198754;
}

.planta-destacada {
    border: 2px solid #ffc107;
}

/* Animaciones para el botón de agregar al carrito */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.btn-success {
    animation: pulse 0.5s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .carrito-flotante {
        bottom: 20px;
        right: 20px;
    }
    
    .carrito-flotante .btn {
        width: 60px;
        height: 60px;
    }
    
    .carousel-item-content {
        padding: 2rem 1rem;
    }
    
    .carousel-item-content h3 {
        font-size: 1.5rem;
    }
    
    .carousel-item-content p, 
    .carousel-item-content li {
        font-size: 1rem;
    }
}
</style>
{% endblock %}
{% endblock %}